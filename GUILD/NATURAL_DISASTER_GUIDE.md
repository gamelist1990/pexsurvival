# 自然災害機能 (Natural Disaster Feature)

## 概要
自然災害機能は、ゲーム中に様々な自然災害をランダムに発生させる機能です。災害は約2分～4分の間隔で発生し、ボスバーに残り時間と現在の災害が表示されます。すべての災害はプレイヤーから最低50ブロック離れた場所で発生し、その時間が終わるまで継続的に実行されます。

## 機能

### コマンド
```
/pex toggle naturaldisaster
```
自然災害機能のON/OFFを切り替えます。

### 災害の種類

1. **雷（Lightning）** ⚡
   - 災害の中心位置から、プレイヤーから最低50ブロック離れた場所で毎秒5回、複数の雷を落とします
   - 半径100ブロック以内にランダムに落下

2. **地震（Earthquake）** 🌍
   - 災害の中心位置から、周辺100ブロック以内のプレイヤーをランダムに揺らします
   - 煙のパーティクルエフェクトが発生します
   - 毎秒実行されます

3. **竜巻（Tornado）** 🌪️ **継続追跡機能**
   - 災害の中心位置で発生し、そこに向かってプレイヤーが吸い込まれます
   - 竜巻の中に吸い込まれたプレイヤーは吹き上げられます
   - クラウドパーティクルで竜巻が可視化されます
   - **ブロックは削除されません**
   - 継続的に追跡します（約2秒間）

4. **台風（Typhoon）** 🌪️⚡ **継続追跡機能**
   - 災害の中心位置で発生し、そこを中心に渦巻きます
   - **FallingBlockを使用してブロックを浮かせます**
   - ブロックを渦巻き状に配置して継続的に回転させます
   - 巻き込まれたプレイヤーは：
     - 1ダメージを受ける
     - 強い風で吹き飛ばされる
   - **台風終了時にブロックは四散します**（自由落下）
   - 周辺のブロック（土、石など）を削り取ります
   - 継続的に追跡します（約5秒間）

5. **火災（Fire）** 🔥 **新：5秒ごとに発火**
   - 災害の中心位置から周辺50ブロック以内の**森を継続的に火災にします**
   - **5秒ごとに最大8つまで木に着火させます**
   - 毎回、ランダムに複数の木を選んで着火
   - 木がない場合は周辺の地面に着火（最大4つ）
   - 継続的に火災を広げます

## パラメータ

### 災害継続時間
- **最小時間**: 120秒（2分）= 2400ティック
- **最大時間**: 240秒（4分）= 4800ティック
- すべての災害がこの時間の間、継続的に発生します

### 災害発生位置
- **最低距離**: プレイヤーから50ブロック以上離れた場所
- **最大距離**: プレイヤーから最大150ブロック離れた場所（50～100ブロック）
- ランダムな方向に発生

### 更新間隔
- **基本間隔**: 毎秒（20ティック）にチェック
- **火災の火の広がり**: 5秒ごと（100ティック）

### 各災害のパラメータ

#### 竜巻（Tornado）
- **半径**: 20ブロック
- **継続時間**: 2秒（40ティック）
- **吹き上げ力**: 1.5 + 上方向速度

#### 台風（Typhoon）
- **半径**: 25ブロック
- **継続時間**: 5秒（100ティック）
- **ブロック生成頻度**: 毎秒8ブロック
- **回転速度**: 0.15ラジアン/ティック
- **ダメージ**: 巻き込まれると1ダメージ

#### 火災（Fire）
- **半径**: 50ブロック（木を探す範囲）
- **火の広がり頻度**: 5秒ごと
- **同時着火数**: 最大8つの木、または4つの地面

## ボスバー表示
災害発生中、画面上部に以下の情報が表示されます：
```
【雷】残り時間: 120秒
【竜巻】残り時間: 60秒
【火災】残り時間: 45秒
```

ボスバーの進捗は、災害の残り時間の割合で更新されます。

## 実装の詳細

### ファイル構成
```
src/main/java/org/pexserver/koukunn/pexsurvival/Module/NaturalDisaster/
├── NaturalDisasterFeature.java   # メイン機能クラス
├── NaturalDisaster.java          # 5種類の災害定義
├── TornadoObject.java            # 竜巻の管理クラス
└── TyphoonObject.java            # 台風の管理クラス
```

### 特徴
- **ワールド毎の独立管理**: 各ワールドで異なる災害が発生します
- **プレイヤー離隔**: すべての災害がプレイヤーから最低50ブロック離れた場所で発生
- **RPGスタイル**: 远方で発生する災害を見守るような体験
- **継続的実行**: 災害が発生中は時間が終わるまで継続的に進行
- **動的ブロック操作**: 台風がFallingBlockでブロックを浮かせます
- **自動クリーンアップ**: 災害終了時に自動的にボスバーがクリアされます
- **プレイヤー同期**: 災害発生時にボスバーがワールド内のすべてのプレイヤーに表示されます

## 使用例

### 有効化
```
/pex toggle naturaldisaster
```
→ 「自然災害機能が有効になりました」
→ 災害が2～4分ごとにランダムに発生開始

### 無効化
```
/pex toggle naturaldisaster
```
→ 「自然災害機能が無効になりました」
→ すべての災害が停止、ボスバーがクリア

## プレイヤー体験

1. **災害が発生**
   - ボスバーに災害名と残り時間が表示
   - 約50～150ブロック離れた場所で災害が発生

2. **プレイヤーの選択肢**
   - 災害に向かって助けに行く
   - 安全な場所に逃げる
   - 災害の影響を見守る

3. **火災の場合**
   - 5秒ごとに新しく複数の木が着火
   - 火災が継続的に広がっていく光景を見守る

## トラブルシューティング

### ボスバーが表示されない
- サーバーが正常に起動しているか確認してください
- 機能が有効化されているか確認してください

### 災害が発生しない
- 機能が有効化されているか確認してください（`/pex toggle naturaldisaster` で確認）
- サーバーログでエラーがないか確認してください
- ワールドにプレイヤーが存在するか確認してください

### 火災でブロックが復元されない
- 台風終了時にブロックが自動的に四散します
- 火災の場合は火を設置するだけで、ブロックは削除されません

### 竜巻・台風が発生した時に位置がおかしい
- これは正常な挙動です。災害はプレイヤーから最低50ブロック以上離れた場所で発生します

## 今後の改善案
- 災害の強度調整可能性
- 災害発生時の警告通知システム
- 特定の災害のみを有効化する設定
- 災害による被害設定（ダメージ量、ブロック削除対象など）
- 複数の災害が同時に発生する可能性
